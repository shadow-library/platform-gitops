name: shadow-local
services:
  postgres:
    image: postgres:18-alpine
    container_name: shadow-postgres
    restart: unless-stopped
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-shadow_db}
    volumes:
      - ./docker/volumes/postgres:/var/lib/postgresql
      - ./config/postgres.conf:/etc/postgresql/postgresql.conf:ro
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-shadow_db}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:8-alpine
    container_name: shadow-redis
    restart: unless-stopped
    ports:
      - '${REDIS_PORT:-6379}:6379'
    volumes:
      - ./docker/volumes/redis:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  vault:
    image: hashicorp/vault:1.21
    container_name: shadow-vault
    restart: unless-stopped
    ports:
      - '${VAULT_PORT:-8200}:8200'
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
    volumes:
      - ./docker/volumes/vault/data:/vault/data
      - ./docker/volumes/vault/logs:/vault/logs
      - ./config/vault.hcl:/vault/config/vault.hcl:ro
    cap_add:
      - IPC_LOCK
    command: vault server -config=/vault/config/vault.hcl
    healthcheck:
      test: >-
        ["CMD", "sh", "-c",
        "wget -qO /dev/null 'http://127.0.0.1:8200/v1/sys/health?uninitok=true&sealedok=true'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  loki:
    image: grafana/loki:3.6
    container_name: shadow-loki
    restart: unless-stopped
    ports:
      - '${LOKI_PORT:-3100}:3100'
    volumes:
      - ./docker/volumes/loki:/loki
      - ./config/loki.yaml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO /dev/null http://127.0.0.1:3100/ready']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  prometheus:
    image: prom/prometheus:v3.9.1
    container_name: shadow-prometheus
    restart: unless-stopped
    ports:
      - '${PROMETHEUS_PORT:-9090}:9090'
    volumes:
      - ./docker/volumes/prometheus:/prometheus
      - ./config/prometheus.yaml:/etc/prometheus/prometheus.yml:ro
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=72h
      - --web.enable-remote-write-receiver
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO /dev/null http://127.0.0.1:9090/-/healthy']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  grafana:
    image: grafana/grafana:12.3
    container_name: shadow-grafana
    restart: unless-stopped
    ports:
      - '${GRAFANA_PORT:-3000}:3000'
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_AUTH_ANONYMOUS_ENABLED: 'true'
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    volumes:
      - ./docker/volumes/grafana:/var/lib/grafana
      - ./config/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml:ro
    depends_on:
      loki:
        condition: service_healthy
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'wget -qO /dev/null http://127.0.0.1:3000/api/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
